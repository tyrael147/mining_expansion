/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-70.12139322056993, -12.924816835746105],
           [-70.12276651158555, -12.962961108129583],
           [-69.92707254185899, -12.962961108129583],
           [-69.92501260533555, -12.920132049251091]]],
         [[[-70.67208291783555, -12.89402948812142],
           [-70.69336892857774, -12.936193808352648],
           [-70.57869912877305, -12.979020106812682],
           [-70.55123330846055, -12.930840003499855]]],
         [[[-70.60410501256212, -13.064650551017364],
           [-70.47776223912462, -13.100767000957708],
           [-70.42145730748399, -13.003106659437556],
           [-70.52926065221055, -12.967645089831787]]],
         [[[-70.40360452428087, -12.91946278686346],
           [-70.41047097935899, -13.072008034614743],
           [-70.32120706334337, -13.07401458298329],
           [-70.31846048131212, -12.925486083784575]]],
         [[[-70.26558877721055, -13.057292848167975],
           [-70.24910928502305, -13.15493173906514],
           [-70.1529789139293, -13.098760670365454],
           [-70.18250467076524, -13.005113766674329]]],
         [[[-70.09873391881212, -12.985041963941843],
           [-70.10628701939805, -13.047259263877114],
           [-69.95934488072618, -13.059299516137072],
           [-69.95110513463243, -13.033877684275556],
           [-69.9387455154918, -12.984372875911024]]],
         [[[-70.08090243307574, -12.844924820127304],
           [-70.09463534323199, -12.889105452201681],
           [-69.92915377584917, -12.902491984844534],
           [-69.91885409323199, -12.857644284416509]]],
         [[[-70.16810641256792, -12.737788058886242],
           [-70.13995394674761, -12.822831588998884],
           [-69.94425997702105, -12.784665987556469],
           [-69.97515902487261, -12.724392770915653]]],
         [[[-70.50614458959858, -12.577605096168703],
           [-70.41550738256733, -12.70825437125423],
           [-70.36881548803608, -12.66873164586615],
           [-70.45052630346576, -12.54878628412515],
           [-70.50683123510639, -12.582296224805932]]],
         [[[-70.59993335055128, -12.685888382533772],
           [-70.63975510146504, -12.749513443017435],
           [-70.43377784095468, -12.811784354887502],
           [-70.41935981392496, -12.7354510855959],
           [-70.51068519862757, -12.719057496602963]]],
         [[[-70.24655250374651, -12.68537617254822],
           [-70.19780067269183, -12.643169927681075],
           [-70.2403726941762, -12.533267044173517],
           [-70.31384376351214, -12.562087594627677],
           [-70.27813819710589, -12.6833665098563]]],
         [[[-70.05694674237647, -12.552704513885121],
           [-70.09471224530616, -12.690735195484377],
           [-69.97180269940772, -12.710830525860747],
           [-69.9436502335874, -12.57415105243532]]],
         [[[-70.21772123945429, -12.982204598516647],
           [-70.18201567304804, -12.960792644062701],
           [-70.19712187421992, -12.908593294790188],
           [-70.27265288007929, -12.891191087089936],
           [-70.28638579023554, -12.951424334674073]]],
         [[[-70.70578609039765, -12.987361672219155],
           [-70.69891963531953, -13.026165329606332],
           [-70.63025508453828, -13.032855001440124],
           [-70.62750850250703, -12.988699830380707]]],
         [[[-70.65032641253389, -12.859398162466016],
           [-70.46767870745576, -12.914284907931844],
           [-70.44433276019014, -12.846009328353798],
           [-70.63384692034639, -12.788429220005966]]],
         [[[-69.91286913714326, -12.705383625105286],
           [-69.87304369769014, -12.82056857841533],
           [-69.81948534808076, -12.787089991190767],
           [-69.86755053362764, -12.67188980873908]]],
         [[[-69.81484606317593, -12.626406907733285],
           [-69.79836657098843, -12.748324984670363],
           [-69.73107531122281, -12.755022084629758],
           [-69.73244860223843, -12.613005761704505]]],
         [[[-69.67339708856656, -12.642487356117918],
           [-69.63357164911343, -12.77243371502538],
           [-69.54568102411343, -12.740288230941237],
           [-69.60198595575406, -12.590222204078374],
           [-69.68438341669156, -12.615686047045843]]],
         [[[-69.47838976434781, -12.57145775461417],
           [-69.40972521356656, -12.694741816321743],
           [-69.32320787958218, -12.641147357398074],
           [-69.43719103387906, -12.523200024430595]]]]),
    roi = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-70.67505849956007, -13.133774724286214],
          [-69.84833730815382, -13.262128458096392],
          [-69.80164541362257, -12.64917546614451],
          [-70.56794180034132, -12.541956211238201],
          [-70.96344961284132, -12.957178860954686]]]),
    classif = {"opacity":1,"bands":["classification"],"palette":["000000","000000","040404","002bff","1bff00","ffeb00","ff0000","ff0000","ff0000","ff0000"]},
    geometry3 = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Geometry.Point([-70.61342239379883, -12.916313159716847]),
    geometry2 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-70.69550337508213, -12.593536989280254],
          [-70.69550337508213, -13.096970296316151],
          [-69.84543623641025, -13.096970296316151],
          [-69.84543623641025, -12.593536989280254]]], null, false),
    all_mining = ee.FeatureCollection("users/glarrea/mining_article/Def_Min_SPA_1984_2017"),
    data_180520 = ee.FeatureCollection("users/glarrea/mining_article/data_180520"),
    data_180520_b = ee.FeatureCollection("users/glarrea/mining_article/data_180520_b"),
    table = ee.FeatureCollection("users/glarrea/mining_article/data_180520_c"),
    geometry4 = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    geometry5 = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    data_anal = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-70.8769697251305, -12.276140148376289],
          [-70.8769697251305, -13.259198972206319],
          [-68.9983076157555, -13.259198972206319],
          [-68.9983076157555, -12.276140148376289]]], null, false),
    point = 
    /* color: #ffc82d */
    /* shown: false */
    ee.Geometry.Point([-69.95793708993457, -12.90340547581532]),
    image = ee.Image("OpenLandMap/SOL/SOL_TEXTURE-CLASS_USDA-TT_M/v02"),
    DEF_MIN_ALL = ee.FeatureCollection("users/glarrea/DEF_MIN_2010_2017"),
    geometry7 = 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-70.63164914208947, -12.626503639891233],
          [-70.63164914208947, -13.116496615029746],
          [-69.70879757958947, -13.116496615029746],
          [-69.70879757958947, -12.626503639891233]]], null, false),
    export_g = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-70.99202366865948, -12.083564545279915],
          [-70.99202366865948, -13.349463607982605],
          [-68.86479588545636, -13.349463607982605],
          [-68.86479588545636, -12.083564545279915]]], null, false),
    geometry10 = 
    /* color: #0b4a8b */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-70.9298385399701, -12.348210982418081],
          [-70.9298385399701, -13.250798890849618],
          [-68.8973678368451, -13.250798890849618],
          [-68.8973678368451, -12.348210982418081]]], null, false),
    to_predict_S1 = ee.Image("users/glarrea/mining_article/to_predict_S1"),
    new_data_pre = ee.Image("users/glarrea/mining_article/data_pre_v5_150620"),
    to_predict_S2 = ee.Image("users/glarrea/mining_article/to_predict_S2"),
    data_pre_hidro = ee.Image("users/glarrea/mining_article/data_pre_hidro"),
    to_predict_S3 = ee.Image("users/glarrea/mining_article/to_predict_S3"),
    clay = ee.Image("OpenLandMap/SOL/SOL_CLAY-WFRACTION_USDA-3A1A1A_M/v02"),
    sand = ee.Image("OpenLandMap/SOL/SOL_SAND-WFRACTION_USDA-3A1A1A_M/v02"),
    geometry6 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[-70.71703165317517, -12.693627745945658],
           [-70.71703165317517, -13.002914858271092],
           [-70.46159952426892, -13.002914858271092],
           [-70.46159952426892, -12.693627745945658]]],
         [[[-70.13722898743981, -12.767159875552466],
           [-70.13722898743981, -13.069667762079039],
           [-69.86943723939294, -13.069667762079039],
           [-69.86943723939294, -12.767159875552466]]],
         [[[-69.60851194642419, -12.554115923063133],
           [-69.60851194642419, -12.713580687062537],
           [-69.37917234681481, -12.713580687062537],
           [-69.37917234681481, -12.554115923063133]]],
         [[[-70.36398913472044, -12.519609092744432],
           [-70.36398913472044, -12.665696966759764],
           [-69.99457385151732, -12.665696966759764],
           [-69.99457385151732, -12.519609092744432]]],
         [[[-69.84488513081419, -12.629517822223692],
           [-69.84488513081419, -12.754113237416371],
           [-69.71030261128294, -12.754113237416371],
           [-69.71030261128294, -12.629517822223692]]],
         [[[-70.47934558003294, -13.011147944326748],
           [-70.47934558003294, -13.170322615831742],
           [-70.27472521870482, -13.170322615831742],
           [-70.27472521870482, -13.011147944326748]]],
         [[[-69.85889969270623, -12.827388528816725],
           [-69.85889969270623, -13.05625589685126],
           [-69.64741287629998, -13.05625589685126],
           [-69.64741287629998, -12.827388528816725]]]], null, false),
    imageVisParam = {"opacity":1,"bands":["distance_villages"],"max":1000,"gamma":1},
    geometry9 = 
    /* color: #ffc82d */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[-70.88682838928372, -13.132912129340166],
           [-70.88682838928372, -13.234531425804297],
           [-70.55861183654935, -13.234531425804297],
           [-70.55861183654935, -13.132912129340166]]],
         [[[-69.68801973223367, -12.896971991199365],
           [-69.68801973223367, -12.9986884298005],
           [-69.50125215410867, -12.9986884298005],
           [-69.50125215410867, -12.896971991199365]]],
         [[[-70.55868623613992, -12.462878412773387],
           [-70.55868623613992, -12.613018999428691],
           [-70.0299691951243, -12.613018999428691],
           [-70.0299691951243, -12.462878412773387]]],
         [[[-69.6924176397636, -12.541329598170478],
           [-69.6924176397636, -12.811972102347022],
           [-69.44659854796673, -12.811972102347022],
           [-69.44659854796673, -12.541329598170478]]],
         [[[-69.4452252569511, -12.447475880087628],
           [-69.4452252569511, -12.66730791308818],
           [-69.2200055303886, -12.66730791308818],
           [-69.2200055303886, -12.447475880087628]]],
         [[[-69.1993087390294, -12.466337521825917],
           [-69.1993087390294, -12.555492857355835],
           [-69.1278976062169, -12.555492857355835],
           [-69.1278976062169, -12.466337521825917]]],
         [[[-69.03314052613878, -12.447564061141636],
           [-69.03314052613878, -12.50388036182402],
           [-68.96035610231066, -12.50388036182402],
           [-68.96035610231066, -12.447564061141636]]]], null, false),
    geometry8 = 
    /* color: #00ffff */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-70.8845194577541, -12.471891907804563],
          [-70.8845194577541, -13.233710079578321],
          [-69.28738200658222, -13.233710079578321],
          [-69.28738200658222, -12.471891907804563]]], null, false),
    geometry11 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-71.17000532787536, -11.91113755111307],
          [-71.17000532787536, -13.742831371712198],
          [-68.67061567943786, -13.742831371712198],
          [-68.67061567943786, -11.91113755111307]]], null, false),
    new_new_data_pre = ee.Image("users/glarrea/mining_article/data_pre_v6_220920");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var landform = ee.Image("CSP/ERGo/1_0/Global/SRTM_landforms");
landform = landform.select([0],['landform']);
var min_proj = ee.Projection({crs:'EPSG:32719'}).atScale(30).aside(print,'min_proj'); 
var limits = ee.FeatureCollection("users/glarrea/mining_RCS/Perulimit"),
    huaype = /* color: #d63000 */geometry,
    srtm = ee.Image("USGS/SRTMGL1_003");
    
clay = clay.select(["b200"],["clay"]);
sand = sand.select(["b200"],["sand"]);    

/////create slope//// 
var slope = ee.Terrain.slope(srtm).clip(limits);
var limitsgeo = limits.geometry(); 

var data_pre = new_data_pre;
// var data_pre = new_new_data_pre;
var ROI = geometry10;
// var ROI = geometry8;

///////////////////////////// Training and testing databases{

var initialYear = 2011;
var lastYear = 2015;

// Training data
// creates rasters from shapefiles, two bands created: "Type" (0:None, 1:SP, 2:HM) and "Mined" (0:None, 1: mined)
var mining_train = all_mining.filter(ee.Filter.gte('Year',initialYear)).filter(ee.Filter.lte('Year',lastYear)).reduceToImage({
                properties: ['Type'], 
                reducer:ee.Reducer.first()}).unmask(0).select(['first'],['type']).toInt8();
                
var mining_bin_train = all_mining.filter(ee.Filter.gte('Year',initialYear)).filter(ee.Filter.lte('Year',lastYear)).reduceToImage({
                properties: ['Type'], 
                reducer:ee.Reducer.first()}).gte(1).unmask(0).select(['first'],['mined']);         
var database_training = ee.Image.cat([data_pre,data_pre_hidro, mining_train, mining_bin_train, clay, sand]);

// External test data 
var initialYear_test = 2016;
var lastYear_test = 2017;

var mining_test = all_mining.filter(ee.Filter.gte('Year',initialYear_test)).filter(ee.Filter.lte('Year',lastYear_test)).reduceToImage({
                properties: ['Type'], 
                reducer:ee.Reducer.first()}).unmask(0).select(['first'],['type']).toInt8();
                
var mining_bin_test = all_mining.filter(ee.Filter.gte('Year',initialYear_test)).filter(ee.Filter.lte('Year',lastYear_test)).reduceToImage({
                properties: ['Type'], 
                reducer:ee.Reducer.first()}).gte(1).unmask(0).select(['first'],['mined']);
                
var database_testing = ee.Image.cat([data_pre,data_pre_hidro, mining_test, mining_bin_test, clay, sand]);
//}

/////////////////Clustering{

//using training dataset to cluster
print(database_training.bandNames(),"bandnames");
var bands= [
  "distance_any",
  "distance_vec",
  "distance_dep",
  "distance_nac",
  "distance_buffer",
  "distance_parks",
  "distance_villages",
  "altitude",
  "slope",
  "longitude",
  "latitude",
  "landform",
  "distance_rivers",
  "distance_ponds",
  // "type",
  "mined",
  "clay",
  "sand"
];
var database_masked = database_training.updateMask(database_training.select(["mined"]))
                      .select(bands);

var training = database_masked.stratifiedSample({ //This sampling selects only values = 1, discards null
    numPoints: 1000,
    classBand: 'mined',
    region: ROI,
    scale: 100,
    geometries: true});

var clusterer_2 = ee.Clusterer.wekaXMeans({minClusters:2, 
  maxClusters:35, 
  maxIterations:4,
  seed:20
  }).train(training);
var clusters = database_masked.cluster(clusterer_2).add(1).unmask(0); //classifying and adding 1 to avoid class=0

var number_clusters = clusters.reduceRegion(    //obtains the number of clusters obtained from the X-means algorithm
  {reducer:ee.Reducer.minMax(),
  geometry:ROI,
  scale: 100
  }).getNumber("cluster_max").aside(print,"Number of clusters");
  
var database_training_clustered = ee.Image.cat([database_training, clusters]); //new database that includes clusters 
/////////////////}

/////////////// Clusters sampling{
var yearsClusters = ee.List.sequence(initialYear, lastYear, 1).aside(print,'Years of clusters')
var listClusters = ee.List.sequence(1, number_clusters, 1).aside(print,'List of clusters')
var clustersPolygon = clusters.reduceToVectors({ //vectorized the raster of cluster in a polygon 
  geometry:geometry10, //The clustering ROI should always be geometry10 (the whole are of MDD)
  scale:100, 
  eightConnected:true, 
  labelProperty:'label', 
  crs: 'EPSG:32719', 
  maxPixels:10e12, 
  tileScale:8, 
  geometryInNativeProjection:true}); // class 'label' sets the cluster
Map.addLayer(clustersPolygon.filterMetadata('label', 'not_equals',0))

// This block calculates the total area corresponding to every cluster for every year using the featurecollection operations using the raw data from 
// caballero-espejo et al. and the vectorized version of the map obtained in the clustering stage 
//{
yearsClusters = yearsClusters.map(function(year){
    var miningYear = all_mining.filter(ee.Filter.eq('Year',year))
    var areaFeatColyear = listClusters.map(function(cluster){
      
      var clusterGeom = clustersPolygon.filterMetadata('label','equals', cluster)
      var minedArea = miningYear.filterBounds(clusterGeom).aggregate_sum('Area_ha')
      var areaFeat = ee.Feature(null,{area:minedArea , year: year, cluster: cluster})
      return(areaFeat)
    })
    areaFeatColyear = ee.FeatureCollection(areaFeatColyear)
    return(areaFeatColyear)
})

Export.table.toDrive({
  collection: ee.FeatureCollection(yearsClusters).flatten(),
  description:'temporal_clustered_polygon',
  folder: 'mining_data_RCR', 
  fileFormat: 'CSV'
});

print(ee.FeatureCollection(yearsClusters).flatten().aggregate_sum('area'), 
        'Verifying - This is the total area') //usually times out in code editor, works perfect and fast if you export as csv
//}
//////////}

//////////Sampling{   
/**
* Three sample sets were extracted 
* sample_1: using the clustering approach
* sample_2: using stratified sampling for the whole sampling area
*/

var samplingArea = geometry7; //region of sampling (small) 
// var samplingArea = geometry10; //region of sampling (all roi)uncomment to test more sampling region 

var half = ee.Number(4000); // number of not mined pixels, the mined sample will have the same number of elements
var factor = ee.Number(1)
var not_mined = half.multiply(factor); //number of not mined pixels,
var mined = half; //dividing the total mined by number of clusters
var mined_cluster = (half.divide(number_clusters).round()); //dividing the total mined by number of clusters

// var outerBox = ROI.symmetricDifference(samplingArea,100); // this outer box will be used to sample an additional test sample 
var outerBox = geometry9; // arbitrary test area
var innerBox = samplingArea;

var totalTestSample = 4000
var samplingScale = 100
var spacing = 600
// var spacing = 300

var classvalues =ee.List.sequence(0, number_clusters).aside(print); // List of clusters (class 0: not mined, class 1: mined cluster 1, ... class: X, mined cluster X)
var classpoints =ee.List([not_mined]).cat(ee.List.repeat(mined_cluster, number_clusters)).aside(print); // List of sampled pixels per class


var sample_0 = database_training_clustered.stratifiedSample({  // clustered - no spaced
    numPoints: 10, //does not count
    classBand: 'cluster',
    classValues: classvalues,
    classPoints: classpoints,
    region: innerBox,
    geometries:true,
    scale: samplingScale,
    projection: 'EPSG:32719'});

var sample_1 = database_training_clustered.stratifiedSample({ // sample points geometries only
    numPoints: 10, //does not count
    classBand: 'cluster',
    classValues: classvalues,
    classPoints: classpoints,
    region: innerBox,
    geometries:true,
    scale: spacing,
    projection: 'EPSG:32719'});

var sample_1 = database_training_clustered.sampleRegions({  //clustered + spaced
  collection:sample_1,
  scale:samplingScale,
  projection: 'EPSG:32719',
  tileScale: 8,
  geometries: true
}).aside(Map.addLayer,{},'sample_1');


var sample_2 = database_training_clustered.stratifiedSample({ // sample points geometries only
    numPoints: 10, //does not count
    classBand: 'mined',
    classValues: [0,1],
    classPoints: [not_mined,mined],
    region: innerBox,
    geometries:true,
    scale: spacing,
    projection: 'EPSG:32719'});

var sample_2 = database_training_clustered.sampleRegions({   //strata + spaced
  collection:sample_2,
  scale:samplingScale,
  projection: 'EPSG:32719',
  tileScale: 8,
  geometries: true
});
print('sample_0', sample_0)

var sample_test_2 = database_training_clustered.stratifiedSample({
    numPoints: 10, //This parameter is overridden 
    classBand: 'mined',
    classValues: [0,1],
    classPoints: [totalTestSample/2,totalTestSample/2],
    region: outerBox,
    geometries:true,
    scale: samplingScale,
    projection: 'EPSG:32719'});
    
// var sample_analysis = database_training_clustered.stratifiedSample({
//     numPoints: 10, //does not count
//     classBand: 'cluster',
//     classValues: classvalues,
//     classPoints: classpoints,
//     region: data_anal,
//     geometries:true,
//     scale: samplingScale,
//     projection: 'EPSG:32719'});
//}



////////////////////Classification{
var to_predict_2017 = ee.Image.cat([data_pre,data_pre_hidro, sand, clay]).aside(Map.addLayer,{},"database");

// Partition the training
var training_mixed_0 = sample_0; // strata-clustering no spacing 
var training_mixed_1 = sample_1; // strata-clustering, spaced
var training_mixed_2 = sample_2 //  strata, spaced

training_mixed_0 = training_mixed_0.randomColumn({ seed: 1 });
training_mixed_1 = training_mixed_1.randomColumn({ seed: 1 });
training_mixed_2 = training_mixed_2.randomColumn({ seed: 1 });

var training_0 = training_mixed_0.filter(ee.Filter.lt('random', 0.8));
var validation_0 = training_mixed_0.filter(ee.Filter.gte('random', 0.8));
var training_1 = training_mixed_1.filter(ee.Filter.lt('random', 0.8));
var validation_1 = training_mixed_1.filter(ee.Filter.gte('random', 0.8));
var training_2 = training_mixed_2.filter(ee.Filter.lt('random', 0.8));
var validation_2 = training_mixed_2.filter(ee.Filter.gte('random', 0.8));
print(validation_1.size(), "validation_1_size");

// var bands =  ['altitude', 'distance_rivers', 'distance_ponds','slope', 'landform'];  //MR1: only geophysical variables
// var bands =  ['distance_any','distance_dep','distance_vec','distance_nac','distance_buffer','distance_parks','distance_villages','altitude', //elevation changed for altitude
//               'slope', 'landform', 'distance_rivers', 'distance_ponds']; //nolonlat
var bands =  ['distance_any','distance_dep','distance_vec','distance_nac','distance_buffer','distance_parks','distance_villages','altitude', //elevation changed for altitude
              'slope', 'landform', 'distance_rivers', 'distance_ponds','clay','sand']; //nolonlat
// var bands =  ['distance_any','distance_dep','distance_vec','distance_nac','distance_buffer','distance_parks','distance_villages', //elevation changed for altitude
//               'slope', 'landform', 'distance_rivers', 'distance_ponds','clay','sand']; //nolonlat
// var bands =  ['distance_dep','distance_vec','distance_nac','distance_buffer','distance_parks','distance_villages','altitude', //elevation changed for altitude
//               'slope', 'landform', 'distance_rivers', 'distance_ponds','clay','sand','latitude','longitude'];  // + all


var classifier_0 = ee.Classifier.smileRandomForest({
  numberOfTrees:  100, 
  bagFraction:0.2,
  maxNodes: 400,
  seed:1}).train({
  features: training_0,
  classProperty: 'mined',
  inputProperties: bands
  })
  .setOutputMode('PROBABILITY');

var classifier_1 = ee.Classifier.smileRandomForest({
  numberOfTrees:  100, 
  bagFraction:0.2,
  maxNodes: 400,
  seed:1}).train({
  features: training_1,
  classProperty: 'mined',
  inputProperties: bands
  })
  .setOutputMode('PROBABILITY');  
  
var classifier_2 = ee.Classifier.smileRandomForest({
  numberOfTrees:  100, 
  bagFraction:0.2,
  maxNodes: 400,
  seed:1}).train({
  features: training_2,
  classProperty: 'mined',
  inputProperties: bands
  })
  .setOutputMode('PROBABILITY');
  
  print("classfier 0", classifier_0.explain()); //Shows the characteristics of the model
print("classfier 1", classifier_1.explain()); 
print("classfier 2",classifier_2.explain()); 

// var trainAccuracy = classifier_1.setOutputMode('CLASSIFICATION').confusionMatrix(); // not valid for probability
// // print('confusion',classifier.confusionMatrix())
// print('trainAccuracy', trainAccuracy);

print('testAccuracy classifier 0: inside sample',validation_0
    .classify(classifier_0.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification')
    .accuracy());                 //only for classification
print(validation_0
    .classify(classifier_0.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification'));

print('testAccuracy classifier 0: outside sample', sample_test_2
    .classify(classifier_0.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification')
    .accuracy());                 //only for classification
print(sample_test_2
    .classify(classifier_0.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification'));

print('testAccuracy classifier 1: inside sample',validation_1
    .classify(classifier_1.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification')
    .accuracy());                 //only for classification
print(validation_1
    .classify(classifier_1.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification'));

print('testAccuracy classifier 1: outside sample', sample_test_2
    .classify(classifier_1.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification')
    .accuracy());                 //only for classification
print(sample_test_2
    .classify(classifier_1.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification'));

print('testAccuracy classifier 2: inside sample',validation_2
    .classify(classifier_2.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification')
    .accuracy());                 //only for classification
print(validation_2
    .classify(classifier_2.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification'));

print('testAccuracy classifier 2: outside sample', sample_test_2
    .classify(classifier_2.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification')
    .accuracy());                 //only for classification
print(sample_test_2
    .classify(classifier_2.setOutputMode('CLASSIFICATION'))
    .errorMatrix('mined', 'classification'));

//}

///////////////// Visualisation{
var classified = to_predict_2017.select(bands).clip(limits).classify(classifier_1);
var class_vis = {palette:['#b2182b','#d6604d','#f4a582','#fddbc7','#f7f7f7','#d1e5f0','#92c5de','#4393c3','#2166ac'].reverse(),
               max: 1, min:0};
var clusters_vis ={palette:["EEEDEE",'black','#a6cee3','#1f78b4','#b2df8a','#33a02c',
                            '#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a',
                            '#ffff99','#b15928'],
                    bands: ['cluster'], min: 0, max:number_clusters.getInfo()};

Map.addLayer(clusters,clusters_vis,"here");
Map.addLayer(classified, class_vis, 'classified_2017');
Map.addLayer(to_predict_2017.select(bands).clip(limits).classify(classifier_0), class_vis, 'classified_2017_model0');
Map.addLayer(to_predict_2017.select(bands).clip(limits).classify(classifier_1), class_vis, 'classified_2017_model1');
Map.addLayer(to_predict_2017.select(bands).clip(limits).classify(classifier_2), class_vis, 'classified_2017_model2');

Map.addLayer(to_predict_2017.select(bands).clip(limits).classify(classifier_1.setOutputMode('CLASSIFICATION')), class_vis, 'classified_2017_class');
// Map.addLayer(sample_test_2, {}, "sample_test2")
Map.addLayer(outerBox,{}, "outerBox")
// Map.addLayer(all_mining.filterMetadata("Year","greater_than", 2008),{color:"green"},"real_2008up");
// Map.addLayer(all_mining.filter(ee.Filter.lte('Year',2015)).filter(ee.Filter.gte('Year',2011)), {color:"green"}, 'trained_11_15');
// Map.addLayer(all_mining.filter(ee.Filter.gte('Year',2016)), {}, 'real_16_17');

///////}


///////////////Exports{

// //Export CSV{
// Export.table.toDrive({ //Exports sample of data (stratified sampling from each cluster) for data analysis
//   collection: sample_analysis,
//   description:'data_anal_13clusters',
//   folder: 'mineria', 
//   fileFormat: 'CSV'
// });

Export.table.toDrive({ 
  collection: validation_1.classify(classifier_1.setOutputMode('PROBABILITY')),
  description:'small_in_clust',
  folder: 'mineria', 
  fileFormat: 'CSV'
});
Export.table.toDrive({
  collection: validation_2.classify(classifier_2.setOutputMode('PROBABILITY')),
  description:'small_in_strata',
  folder: 'mineria', 
  fileFormat: 'CSV'
});
Export.table.toDrive({ 
  collection: sample_test_2.classify(classifier_1.setOutputMode('PROBABILITY')),
  description:'small_out_clust',
  folder: 'mineria', 
  fileFormat: 'CSV'
});
Export.table.toDrive({
  collection: sample_test_2.classify(classifier_2.setOutputMode('PROBABILITY')),
  description:'small_out_strata',
  folder: 'mineria', 
  fileFormat: 'CSV'
});


Export.table.toDrive({ //uncomment only when ROI has been
  collection: validation_1.classify(classifier_1.setOutputMode('PROBABILITY')),
  description:'big_in_clust',
  folder: 'mineria', 
  fileFormat: 'CSV'
});
Export.table.toDrive({
  collection: validation_2.classify(classifier_2.setOutputMode('PROBABILITY')),
  description:'big_in_strata',
  folder: 'mineria', 
  fileFormat: 'CSV'
});

//}

//Export maps {

Export.image.toAsset({
  image:clusters, 
  description:'13_clusters', 
  assetId:'mining_article/rasters_new/13_clusters', 
  region: data_anal, 
  scale:100, 
  crs: 'EPSG:32719',
  maxPixels:1e13
  });

Export.image.toAsset({
  image:to_predict_2017.select(bands).classify(classifier_0.setOutputMode('PROBABILITY')), 
  description:'static_small_cluster_nospace_3', 
  assetId:'mining_article/rasters_new/static_small_cluster_3', 
  region: geometry11, 
  scale:100, 
  crs: 'EPSG:32719',
  maxPixels:1e13
  });

Export.image.toAsset({
  image:to_predict_2017.select(bands).classify(classifier_1.setOutputMode('PROBABILITY')), 
  description:'static_small_cluster_3', 
  assetId:'mining_article/rasters_new/static_small_cluster_3', 
  region: geometry11, 
  scale:100, 
  crs: 'EPSG:32719',
  maxPixels:1e13
  });

Export.image.toAsset({
  image:to_predict_2017.select(bands).classify(classifier_2.setOutputMode('PROBABILITY')), 
  description:'static_small_strata_3', 
  assetId:'mining_article/rasters_new/static_small_strata_3', 
  region: geometry11, 
  scale:100, 
  crs: 'EPSG:32719',
  maxPixels:1e13
  });
Export.image.toAsset({
  image:to_predict_2017.select(bands).classify(classifier_2.setOutputMode('PROBABILITY')), 
  description:'static_big_strata_3', 
  assetId:'mining_article/rasters_new/static_big_strata_3', 
  region: geometry11, 
  scale:100, 
  crs: 'EPSG:32719',
  maxPixels:1e13
  });
Export.image.toAsset({
  image:to_predict_2017.select(bands).classify(classifier_1.setOutputMode('PROBABILITY')), 
  description:'static_big_clustering_3', 
  assetId:'mining_article/rasters_new/static_big_clustering_3', 
  region: geometry11, 
  scale:100, 
  crs: 'EPSG:32719',
  maxPixels:1e13
  });
//}
///}



//Visualization of errors {
var sample_errors = database_training_clustered.stratifiedSample({
    numPoints: 10, //This parameter is overridden 
    classBand: 'mined',
    classValues: [0,1],
    classPoints: [4000,4000],
    region: geometry10, // in all ROI 
    geometries:true,
    scale: samplingScale,
    projection: 'EPSG:32719'});
    

var sample_errors_classified = sample_errors.classify(classifier_1.setOutputMode('PROBABILITY'))
print(sample_errors_classified.first())

var as_1 = sample_errors_classified.filter(ee.Filter.gte('classification',0.5))
print(as_1.first())
var as_0 = sample_errors_classified.filter(ee.Filter.lt('classification',0.5))


var ok_1 = as_1.filter(ee.Filter.eq('mined',1))
var ok_0 = as_0.filter(ee.Filter.eq('mined',0))
var error_1 = as_1.filter(ee.Filter.neq('mined',1))
var error_0 = as_0.filter(ee.Filter.neq('mined',0))

Map.addLayer(ok_1.merge(ok_0),{color:'black'},'_ok_1')
Map.addLayer(error_1,{color:'blue'},'_error_1')
Map.addLayer(error_0,{color:'red'},'_error_0')

Export.table.toDrive({
  collection:sample_errors_classified, 
  description:'sample_errors_classified', 
  folder:'mineria', 
  fileNamePrefix:'sample_errors_classified', 
  fileFormat:'SHP'
  })


//}